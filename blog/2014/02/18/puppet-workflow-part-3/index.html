
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a Functional Puppet Workflow Part 3: Dynamic Environments With R10k - Shit Gary Says</title>
  <meta name="author" content="Gary larizza">

  
  <meta name="description" content="Workflows are like kickball games: everyone knows the general idea of what&rsquo;s
going on, there&rsquo;s an orderly progression towards an end-goal &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://garylarizza.com/blog/2014/02/18/puppet-workflow-part-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Shit Gary Says" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37766331-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Shit Gary Says</a></h1>
  
    <h2>...things I don't want to forget</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:garylarizza.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building a Functional Puppet Workflow Part 3: Dynamic Environments With R10k</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-18T09:48:18-08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Workflows are like kickball games: everyone knows the general idea of what&rsquo;s
going on, there&rsquo;s an orderly progression towards an end-goal, nobody wants to
be excluded, and people lose their shit when they get hit in the face by a big
rubber ball.  Okay, so maybe it&rsquo;s not a perfect mapping but you get the idea.</p>

<p>The previous two posts (<a href="http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-1/">one</a> and <a href="http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-2/">two</a>) focused on
writing modules, wrapping modules, and classification. While BOTH of these
things are very important in the grand scheme of things, one of the biggest
problems people get hung-up on is how do you iterate upon your modules, and,
more importantly, how do you eventually get these changes pushed into production
in a reasonably orderly fashion?</p>

<p>This post is going to be all over the place. We&rsquo;re gonna cover the idea of
separate environments in Puppet, touch on dynamic environments, and round it
out with that mother-of-a-shell-script-turned-personal-savior, R10k. Hold on
to your shit.</p>

<h2>Puppet Environments</h2>

<p><a href="http://docs.puppetlabs.com/guides/environment.html">Puppet has the concept of &lsquo;environments&rsquo;</a> where you can logically
separate your modules and manifest (read: <code>site.pp</code>) into separate folders
to allow for nodes to get entirely separate bits of code based on which
&lsquo;environment&rsquo; the node belongs to.</p>

<p>Puppet environments are statically set in <code>puppet.conf</code>, but,
<a href="http://bit.ly/puppetgit">as other blog posts have noted</a>, you can do some crafty things in
<code>puppet.conf</code> to give you the solution of having &lsquo;dynamic environments&rsquo;.</p>

<p><strong>NOTE</strong>: The solutions in this post are going to rely on Puppet environments,
however environments aren&rsquo;t without their own shortcomings
<a href="http://projects.puppetlabs.com/issues/12173">namely, this bug on Ruby plugins in Puppet</a>). For testing and
promoting Puppet classes written in the DSL, environments will help you out
greatly. For complete separation of Ruby instances and any plugins to Puppet
written in Ruby, however, you&rsquo;ll need separate masters (which is something that
I won&rsquo;t be covering in this article).</p>

<h2>One step further &ndash; &lsquo;dynamic&rsquo; environments</h2>

<p>Adrien Thebo, hitherto known as &lsquo;Finch&rsquo;, &ndash; who is known for building awesome
things and talking like he&rsquo;s fresh from a Redbull binge &ndash; created the
<a href="http://bit.ly/puppetgit">now-famous blog post on creating dynamic environments in Puppet with git.</a>
That post relied upon a post-commit hook to do all the jiggery-pokery necessary
to checkout the correct branches in the correct places, and thus it had a heavy
reliance upon git.</p>

<p>Truly, the only magic in <code>puppet.conf</code> was the inclusion of &lsquo;$environment&rsquo; in
the <code>modulepath</code> configuration entry on the Puppet master (literally that
string and not the evaluated form of your environment). By doing that, the
Puppet master would replace the string &lsquo;$environment&rsquo; with the environment
of the node checking in and would look to that path for Puppet manifests
and modules. If you use something OTHER than git, it would be up to you to
create a post-receive hook that populated those paths, but you could still
replicate the results (albiet with a little work on your part).</p>

<p>People used this pattern and it worked fairly well. Hell, it STILL works
fairly well, nothing has changed to STOP you from using it. What changed,
however, was the ecosystem around modules, the need for individual module
testing, and the further need to automate this whole goddamn process.</p>

<p>Before we deliver the &lsquo;NEW SOLUTION&rsquo;, let&rsquo;s provide a bit of history and
context.</p>

<h2>Module repositories: the one-to-many problem</h2>

<p>I <a href="http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-1/">touched on this topic in the first post</a>, but one of the first
problems you encounter when putting your modules in version control is whether
or not to have ONE GIANT REPO with all of your modules, or a repository for
every module you create. In the past we recommended putting every module in
one repository (namely because it was easier, the module sharing landscape
was pretty barren, and teams were smaller). Now, we recommend the opposite
for the following reasons:</p>

<ul>
<li>Individual repos mean individual module development histories</li>
<li>Most VCS solutions don&rsquo;t have per-folder ACLs for a single repositories;
having multiple repos allows per-module security settings.</li>
<li>With the one-repository-per-module solution, modules you pull down from the
Forge (or Github) must be committed to your repo. Having multiple
repositories for each module allow you to keep everything separate</li>
<li>Publishing this module to the Forge (or Github/Stash/whatever) is easier
with separate repos (rather than having to split-out the module later).</li>
</ul>


<p>The problem with having a repository for every Puppet module you create is that
you need a way to map every module with every Puppet master (and, also which
version of every module should be installed in which Puppet environment).</p>

<p><a href="https://github.com/rodjek/librarian-puppet">A project called librarian-puppet</a> sprang up that created the
&lsquo;<code>Puppetfile</code>&rsquo;, a file that would map modules and their versions to a
specific directory. Librarian was awesome,
<a href="http://somethingsinistral.net/blog/scaling-puppet-environment-deployment/">but, as Finch noted in his post</a>, it had some shortcomings
when used in an environment with many and fast-changing modules.
<a href="http://somethingsinistral.net/blog/scaling-puppet-environment-deployment/">His solution, that he documented here,</a>, was the tool we now come
to know as R10k.</p>

<h2>Enter R10k</h2>

<p>R10k is essentially a Ruby project that wraps a bunch of shell commands you
would NORMALLY use to maintain an environment of ever-changing Puppet modules.
Its power is in its ability to use Git branches combined with a <code>Puppetfile</code>
to keep your Puppet environments in-sync. Because of this, R10k is CURRENTLY
restricted to git. There have been rumblings of porting it to Hg or svn, but
I know of no serious attempts at doing this (and if you ARE doing this, may
god have mercy on your soul). Great, so how does it work?</p>

<p>Well, you&rsquo;ll need one main repository SIMPLY for tracking the <code>Puppetfile</code>.
<a href="https://github.com/glarizza/puppet_repository">I&rsquo;ve got one right here,</a> and it only has my <code>Puppetfile</code> and a
<code>site.pp</code> file for classification (should you use it).</p>

<p><strong>NOTE</strong>: The Puppetfile and librarian-puppet-like capabilities under the hood
are going to be doing most of the work here &ndash; this repository is solely so you
can create topic branches with changes to your <code>Puppetfile</code> that will
eventually become dynamically-created Puppet environments.</p>

<p>Let&rsquo;s take a look at the <code>Puppetfile</code> and see what&rsquo;s going on:</p>

<figure class='code'><figcaption><span>Puppetfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">forge</span> <span class="s2">&quot;http://forge.puppetlabs.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Modules from the Puppet Forge</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/stdlib&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/apache&quot;</span><span class="p">,</span> <span class="s2">&quot;0.11.0&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/pe_gem&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/mysql&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/firewall&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/vcsrepo&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/git&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;puppetlabs/inifile&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;zack/r10k&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;gentoo/portage&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;thias/vsftpd&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># Modules from Github using various references</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;wordpress&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;git://github.com/hunner/puppet-wordpress.git&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;0.4.0&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;property_list_key&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;git://github.com/glarizza/puppet-property_list_key.git&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;952a65d9ea2c5809f4e18f30537925ee45548abc&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mod</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">&#39;git://github.com/glarizza/puppet-redis&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;feature/debian_support&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This example lists the syntax for dealing with modules from both the
Forge and Github, as well as pulling specific versions of modules (whether
versions in the case of the Forge, or Github references as tags, branches,
or even specific commits). The syntax is not hard to follow &ndash; just remember
that we&rsquo;re mapping modules and their versions to a set/known environment.</p>

<p>For every topic branch on this repository (containing the <code>Puppetfile</code>), R10k
will in turn create a Puppet environment with the same name. For this reason,
it&rsquo;s convention to rename the &lsquo;master&rsquo; branch to &lsquo;production&rsquo; since that&rsquo;s the
default environment in Puppet (note that renaming branches locally is easy &ndash;
renaming the branch on Github can sometimes be a pain in the ass). You will
also note why it&rsquo;s going to be somewhat hard to map R10k to subversion, for
example, due to the lack of lightweight branching schemes.</p>

<p>To explain any more of R10k reads just as if I were describing its installation,
so let&rsquo;s quit screwing around and actually INSTALL/SETUP the damn thing.</p>

<h2>Setting up R10k</h2>

<p>As I mentioned before, we <a href="https://github.com/glarizza/puppet_repository">have the main repository</a> that will be
used to track the <code>Puppetfile</code>, which in turn will track the modules to
be installed (whether from The Forge, Github, or some internal git repo). Like
any good Puppet component, R10k itself can be setup with a Puppet module.
<a href="http://forge.puppetlabs.com/zack/r10k">The module I&rsquo;ll be using</a> was developed by <a href="https://github.com/acidprime">Zack Smith</a>,
and is pretty simple to get started. Let&rsquo;s download it from the forge first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 vagrant]# puppet module install zack/r10k
</span><span class='line'>Notice: Preparing to install into /etc/puppetlabs/puppet/modules ...
</span><span class='line'>Notice: Downloading from https://forge.puppetlabs.com ...
</span><span class='line'>Notice: Installing -- do not interrupt ...
</span><span class='line'>/etc/puppetlabs/puppet/modules
</span><span class='line'>└─┬ zack-r10k (v1.0.2)
</span><span class='line'>  ├─┬ gentoo-portage (v2.1.0)
</span><span class='line'>  │ └── puppetlabs-concat (v1.0.1)
</span><span class='line'>  ├── mhuffnagle-make (v0.0.2)
</span><span class='line'>  ├── puppetlabs-gcc (v0.1.0)
</span><span class='line'>  ├── puppetlabs-git (v0.0.3)
</span><span class='line'>  ├── puppetlabs-inifile (v1.0.1)
</span><span class='line'>  ├── puppetlabs-pe_gem (v0.0.1)
</span><span class='line'>  ├── puppetlabs-ruby (v0.1.0)
</span><span class='line'>  └── puppetlabs-vcsrepo (v0.2.0)</span></code></pre></td></tr></table></div></figure>


<p>The module will be installed into the first path in your modulepath, which in
the case above is <code>/etc/puppetlabs/puppet/modules</code>. This modulepath will change
due to the way we&rsquo;re going to setup our dynamic Puppet environments. For this
example, I&rsquo;m going to have environments dynamically generated at
<code>/etc/puppetlabs/puppet/environments</code>, so let&rsquo;s create that directory first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 vagrant]# mkdir -p /etc/puppetlabs/puppet/environments</span></code></pre></td></tr></table></div></figure>


<p>Now, we need to setup R10k on this machine. The module we downloaded will
allow us to do that, but we&rsquo;ll need to create a small Puppet manifest that
will allow us to setup R10k out-of-band from a regular Puppet run (you CAN
continuously-enforce R10k configuration in-band with your regular Puppet
run, but if we&rsquo;re setting up a Puppet master to use R10k to serve out dynamic
environments it&rsquo;s possible to create a chicken-and-egg situation.). Let&rsquo;s
generate a file called <code>r10k_installation.pp</code> in <code>/var/tmp</code> and have it look
like the following:</p>

<figure class='code'><figcaption><span>/var/tmp/r10k_installation.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;r10k&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">version</span>           <span class="p">=&gt;</span> <span class="s1">&#39;1.1.3&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">sources</span>           <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;puppet&#39;</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;remote&#39;</span>  <span class="p">=&gt;</span> <span class="s1">&#39;https://github.com/glarizza/puppet_repository.git&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;basedir&#39;</span> <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${::settings::confdir}</span><span class="s2">/environments&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;prefix&#39;</span>  <span class="p">=&gt;</span> <span class="ss">false</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">purgedirs</span>         <span class="p">=&gt;</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">${::settings::confdir}</span><span class="s2">/environments&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="nt">manage_modulepath</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">modulepath</span>        <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${::settings::confdir}</span><span class="s2">/environments/</span><span class="se">\$</span><span class="s2">environment/modules:/opt/puppet/share/puppet/modules&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what is every section of that declaration doing?</p>

<ul>
<li><strong><code>version =&gt; '1.1.3'</code></strong> sets the version of the R10k gem to install</li>
<li><strong><code>sources =&gt; {...}</code></strong> is a hash of sources that R10k is going to track. For
now it&rsquo;s only our <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>, but you can also track a Hiera
installation too. This hash accepts key/value pairs for configuration settings
that are going to be written to <code>/etc/r10k.yaml</code>, which is R10k&rsquo;s main
configuration file. The keys in-use are <code>remote</code>, which is the path to the
repository to-be-checked-out by R10k, <code>basedir</code>, which is the path on-disk
to where dynamic environments are to be created (we&rsquo;re using the
<code>$::settings::confdir</code> variable which maps to the Puppet master&rsquo;s configuration
directory, or <code>/etc/puppetlabs/puppet</code>), and <code>prefix</code> which is a boolean
to determine whether to use R10k&rsquo;s source-prefixing feature. <strong>NOTE: the <code>false</code>
value is a BOOLEAN value, and thus SHOULD NOT BE QUOTED. Quoting it turns it
into a string, which matches as a boolean TRUE value. Don&rsquo;t quote <code>false</code> &ndash;
that&rsquo;s bad, mmkay.</strong></li>
<li><strong><code>purgedirs=&gt; ["${::settings::confdir}/environments"]</code></strong> is configuring R10k
to implement purging on the environments directory (so any folders that R10k
doesn&rsquo;t create it will delete). This configuration MAY be moot with newer
versions of R10k as I believe it implements this behavior by default.</li>
<li><strong><code>manage_modulepath =&gt; true</code></strong> will ensure that this module sets the <code>modulepath</code>
configuration item in <code>/etc/puppetlabs/puppet/puppet.conf</code></li>
<li><strong><code>modulepath =&gt; ...</code></strong> sets the <code>modulepath</code> value to be dropped into
<code>/etc/puppetlabs/puppet/puppet.conf</code>. Note that we are interpolating variables
(<code>$::settings::confdir</code> again), AND inserting the LITERAL string of <code>$environment</code>
into the <code>modulepath</code> &ndash; this is because Puppet will replace <code>$environment</code> with
the value of the agent&rsquo;s environment at catalog compilation.</li>
</ul>


<p><strong>JUST IN CASE YOU MISSED IT: Don&rsquo;t quote the <code>false</code> value for the prefix setting
in the <code>sources</code> block. That is all.</strong></p>

<p>Okay, we have our one-time Puppet manifest, and now the only thing left to do
is to run it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 tmp]# puppet apply /var/tmp/r10k_installation.pp
</span><span class='line'>Notice: Compiled catalog for master1 in environment production in 2.05 seconds
</span><span class='line'>Notice: /Stage[main]/R10k::Config/File[r10k.yaml]/ensure: defined content as '{md5}0b619d5148ea493e2d6a5bb205727f0c'
</span><span class='line'>Notice: /Stage[main]/R10k::Config/Ini_setting[R10k Modulepath]/value: value changed '/etc/puppetlabs/puppet/modules:/opt/puppet/share/puppet/modules' to '/etc/puppetlabs/puppet/environments/$environment/modules:/opt/puppet/share/puppet/modules'
</span><span class='line'>Notice: /Package[r10k]/ensure: created
</span><span class='line'>Notice: /Stage[main]/R10k::Install::Pe_gem/File[/usr/bin/r10k]/ensure: created
</span><span class='line'>Notice: Finished catalog run in 10.55 seconds</span></code></pre></td></tr></table></div></figure>


<p>At this point, it goes without saying that <code>git</code> needs to be installed, but
if you&rsquo;re firing up a new VM that DOESN&rsquo;T have <code>git</code>, then R10k is going to
spit out an awesome error &ndash; so ensure that <code>git</code> is installed.  After that,
let&rsquo;s synchronize R10k with the <code>r10k deploy environment -pv</code> command (<code>-p</code>
for <code>Puppetfile</code> synchronization and <code>-v</code> for verbose mode):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 puppet]# r10k deploy environment -pv
</span><span class='line'>[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
</span><span class='line'>[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying redis into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying property_list_key into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying make into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying concat into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying ruby into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying redis into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying property_list_key into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying make into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying concat into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying ruby into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment master
</span><span class='line'>[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying redis into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying property_list_key into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying redis into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying property_list_key into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/master/modules
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment development
</span><span class='line'>[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying property_list_key into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying property_list_key into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/development/modules
</span><span class='line'>[R10K::Task::Deployment::PurgeEnvironments - INFO] Purging stale environments from /etc/puppetlabs/puppet/environments</span></code></pre></td></tr></table></div></figure>


<p>I ran this first synchronization with verbose mode so you can see exactly what&rsquo;s
getting copied where. Futher synchronizations don&rsquo;t have to be in verbose mode,
but it&rsquo;s good for debugging. After all of that, we have an
<code>/etc/puppetlabs/puppet/environments</code> folder containing our dynamic Puppet
environments based off of the branches of the <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 puppet]# ls -lah /etc/puppetlabs/puppet/environments/
</span><span class='line'>total 20K
</span><span class='line'>drwxr-xr-x 5 root root 4.0K Feb 19 11:44 .
</span><span class='line'>drwxr-xr-x 7 root root 4.0K Feb 19 11:25 ..
</span><span class='line'>drwxr-xr-x 4 root root 4.0K Feb 19 11:44 development
</span><span class='line'>drwxr-xr-x 5 root root 4.0K Feb 19 11:43 master
</span><span class='line'>drwxr-xr-x 5 root root 4.0K Feb 19 11:42 production
</span><span class='line'>
</span><span class='line'>[root@master1 puppet]# cd /etc/puppetlabs/puppet/environments/production/
</span><span class='line'>[root@master1 production]# git branch -a
</span><span class='line'>  master
</span><span class='line'>* production
</span><span class='line'>  remotes/origin/HEAD -&gt; origin/master
</span><span class='line'>  remotes/origin/development
</span><span class='line'>  remotes/origin/master
</span><span class='line'>  remotes/origin/production</span></code></pre></td></tr></table></div></figure>


<p>As you can see (at the time of this writing), my <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>
has three main branches: <code>development</code>, <code>master</code>, and <code>production</code>, and so
R10k created three Puppet environments matching those names. It&rsquo;s somewhat
of a convention to rename the master branch to <code>production</code>, but in this
case I left it alone to demonstrate how this works.</p>

<p><strong>ONE OTHER BIG GOTCHA</strong>: R10k does NOT resolve dependencies, and
so it is UP TO YOU to track them in your Puppetfile.  Check this out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 production]# puppet module list
</span><span class='line'>Warning: Module 'puppetlabs-firewall' (v1.0.0) fails to meet some dependencies:
</span><span class='line'>  'puppetlabs-puppet_enterprise' (v3.1.0) requires 'puppetlabs-firewall' (v0.3.x)
</span><span class='line'>Warning: Module 'puppetlabs-stdlib' (v4.1.0) fails to meet some dependencies:
</span><span class='line'>  'puppetlabs-pe_accounts' (v2.0.1) requires 'puppetlabs-stdlib' (v3.2.x)
</span><span class='line'>  'puppetlabs-pe_mcollective' (v0.1.14) requires 'puppetlabs-stdlib' (v3.2.x)
</span><span class='line'>  'puppetlabs-puppet_enterprise' (v3.1.0) requires 'puppetlabs-stdlib' (v3.2.x)
</span><span class='line'>  'puppetlabs-request_manager' (v0.0.10) requires 'puppetlabs-stdlib' (v3.2.x)
</span><span class='line'>Warning: Missing dependency 'cprice404-inifile':
</span><span class='line'>  'puppetlabs-pe_puppetdb' (v0.0.11) requires 'cprice404-inifile' (&gt;=0.9.0)
</span><span class='line'>  'puppetlabs-puppet_enterprise' (v3.1.0) requires 'cprice404-inifile' (v0.10.x)
</span><span class='line'>  'puppetlabs-puppetdb' (v1.5.1) requires 'cprice404-inifile' (&gt;= 0.10.3)
</span><span class='line'>Warning: Missing dependency 'puppetlabs-concat':
</span><span class='line'>  'puppetlabs-apache' (v0.11.0) requires 'puppetlabs-concat' (&gt;= 1.0.0)
</span><span class='line'>  'gentoo-portage' (v2.1.0) requires 'puppetlabs-concat' (v1.0.x)
</span><span class='line'>Warning: Missing dependency 'puppetlabs-gcc':
</span><span class='line'>  'zack-r10k' (v1.0.2) requires 'puppetlabs-gcc' (&gt;= 0.0.3)
</span><span class='line'>/etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'>├── gentoo-portage (v2.1.0)
</span><span class='line'>├── mhuffnagle-make (v0.0.2)
</span><span class='line'>├── property_list_key (???)
</span><span class='line'>├── puppetlabs-apache (v0.11.0)
</span><span class='line'>├── puppetlabs-firewall (v1.0.0)  invalid
</span><span class='line'>├── puppetlabs-git (v0.0.3)
</span><span class='line'>├── puppetlabs-inifile (v1.0.1)
</span><span class='line'>├── puppetlabs-mysql (v2.2.1)
</span><span class='line'>├── puppetlabs-pe_gem (v0.0.1)
</span><span class='line'>├── puppetlabs-ruby (v0.1.0)
</span><span class='line'>├── puppetlabs-stdlib (v4.1.0)  invalid
</span><span class='line'>├── puppetlabs-vcsrepo (v0.2.0)
</span><span class='line'>├── redis (???)
</span><span class='line'>├── ripienaar-concat (v0.2.0)
</span><span class='line'>├── thias-vsftpd (v0.2.0)
</span><span class='line'>├── wordpress (???)
</span><span class='line'>└── zack-r10k (v1.0.2)
</span><span class='line'>/opt/puppet/share/puppet/modules
</span><span class='line'>├── cprice404-inifile (v0.10.3)
</span><span class='line'>├── puppetlabs-apt (v1.1.0)
</span><span class='line'>├── puppetlabs-auth_conf (v0.1.7)
</span><span class='line'>├── puppetlabs-firewall (v0.3.0)  invalid
</span><span class='line'>├── puppetlabs-java_ks (v1.1.0)
</span><span class='line'>├── puppetlabs-pe_accounts (v2.0.1)
</span><span class='line'>├── puppetlabs-pe_common (v0.1.0)
</span><span class='line'>├── puppetlabs-pe_mcollective (v0.1.14)
</span><span class='line'>├── puppetlabs-pe_postgresql (v0.0.5)
</span><span class='line'>├── puppetlabs-pe_puppetdb (v0.0.11)
</span><span class='line'>├── puppetlabs-postgresql (v2.5.0)
</span><span class='line'>├── puppetlabs-puppet_enterprise (v3.1.0)
</span><span class='line'>├── puppetlabs-puppetdb (v1.5.1)
</span><span class='line'>├── puppetlabs-reboot (v0.1.2)
</span><span class='line'>├── puppetlabs-request_manager (v0.0.10)
</span><span class='line'>├── puppetlabs-stdlib (v3.2.0)  invalid
</span><span class='line'>└── ripienaar-concat (v0.2.0)</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve installed Puppet Enterprise 3.1.0, and so <code>/opt/puppet/share/puppet/modules</code>
reflects the state of the Puppet Enterprise (also known as &lsquo;PE&rsquo;) modules at that
time. You can see that there are some conflicts because certain modules require
certain versions of other modules. This is currently the nature of the beast
with regard to Puppet modules. Some of these errors are loud and incidental
(i.e. someone set a dependency on a version and forgot to update it), some
are due to namespace changes (i.e. <code>cfprice-inifile</code> being ported over to
<code>puppetlabs-inifile</code>), and so on. Basically, ensure that you handle the
dependencies you care about inside the <code>Puppetfile</code> as R10k won&rsquo;t do it for you.</p>

<p>There &ndash; we&rsquo;ve done it!  We&rsquo;ve configured R10k!  Now how the hell do you use it?</p>

<h2>R10k demonstration &ndash; from module iteration to environment iteration</h2>

<p>Let&rsquo;s take the environment we&rsquo;ve setup in the previous steps and walk you
through adding a new module to your production environment, iterating upon
that module, pushing the changes to that module, pushing the changes to a
Puppet environment, and then promoting those changes to production.</p>

<p><strong>NOTES ON THE SETUP OF THIS DEMO:</strong></p>

<ul>
<li>In this demonstration, classification method is going to be left to the user
(i.e. it&rsquo;s not a part of the magic).  So, when I tell you to classify your
node with a specific class, I don&rsquo;t care if you use the Puppet Enterprise
Console, <code>site.pp</code>, or any other manner.</li>
<li>I&rsquo;m using Github for my repositories so that you folk watching and playing
along at home can have something to follow. Feel free to substitute Github
for something like Atlassian Stash/Bitbucket, internal repos, or whatever.</li>
</ul>


<h3>Add the module to an environment</h3>

<p>The module we&rsquo;ll be working with, <a href="https://github.com/glarizza/puppet-notifyme">a simple module called &lsquo;notifyme&rsquo;</a>,
will notify a message that will help us track the module&rsquo;s process through all
phases of iteration.</p>

<p>The first thing we need to do is to add the module to an environment, so let&rsquo;s
dynamically create a NEW environment by creating a new topic branch and pushing
it up to <a href="https://github.com/glarizza/puppet_repository">the main puppet repo</a>. I will perform this step on my laptop
and outside of the VM I&rsquo;m using to test R10k:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet_repository)▷ git branch
</span><span class='line'>  master
</span><span class='line'>* production
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git checkout -b notifyme
</span><span class='line'>Switched to a new branch 'notifyme'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ vim Puppetfile
</span><span class='line'>
</span><span class='line'># Perform the changes to Puppetfile here
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git add Puppetfile
</span><span class='line'>└(~/src/puppet_repository)▷ git commit
</span><span class='line'>[notifyme 5239538] Add the 'notifyme' module
</span><span class='line'> 1 file changed, 3 insertions(+)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git push origin notifyme:notifyme
</span><span class='line'>Counting objects: 5, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (3/3), 348 bytes, done.
</span><span class='line'>Total 3 (delta 1), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet_repository.git
</span><span class='line'> * [new branch]      notifyme -&gt; notifyme</span></code></pre></td></tr></table></div></figure>


<p>The contents I added to my <code>Puppetfile</code> look like this:</p>

<figure class='code'><figcaption><span>Puppetfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="s2">&quot;notifyme&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;git://github.com/glarizza/puppet-notifyme.git&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Perform an R10k synchronization</h3>

<p>To pull the new dynamic environment down to the Puppet master, do another
R10k synchronization with <code>r10k deploy environment -pv</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 production]# r10k deploy environment -pv
</span><span class='line'>[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
</span><span class='line'>&lt;snip for brevity&gt;
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment notifyme
</span><span class='line'>[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying notifyme into /etc/puppetlabs/puppet/environments/notifyme/modules
</span><span class='line'>&lt;more snipping&gt;</span></code></pre></td></tr></table></div></figure>


<p>I only included the relevant messages, but you can see that it pulled in a new
environment called &lsquo;notifyme&rsquo; that ALSO pulled in a module called &lsquo;notifyme&rsquo;</p>

<h3>Rename the branch to avoid confusion</h3>

<p>Suddenly I realize that this may get confusing having both an environment called
&lsquo;notifyme&rsquo; with a module/class called &lsquo;notifyme&rsquo;. No worries, how about we rename
that branch?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet_repository)▷ git branch -m notifyme garysawesomeenvironment
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git push origin :notifyme
</span><span class='line'>To https://github.com/glarizza/puppet_repository.git
</span><span class='line'> - [deleted]         notifyme
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git push origin garysawesomeenvironment:garysawesomeenvironment
</span><span class='line'>Counting objects: 5, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (3/3), 348 bytes, done.
</span><span class='line'>Total 3 (delta 1), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet_repository.git
</span><span class='line'> * [new branch]      garysawesomeenvironment -&gt; garysawesomeenvironment</span></code></pre></td></tr></table></div></figure>


<p>That bit of <code>git</code> renamed the &lsquo;notifyme&rsquo; branch to &lsquo;garysawesomeenvironment&rsquo;.
The next git command is a bit tricky &ndash; when you <code>git push</code> to a remote, it&rsquo;s
supposed to be:</p>

<p><strong><code>git push name_of_origin local_branch_name:remote_branch_name</code></strong></p>

<p>In our case, the name of our origin is LITERALLY &lsquo;origin&rsquo;, but we actually want
to DELETE a remote branch. The way to delete a local branch is with
<code>git branch -d branch_name</code>, but the way to delete a REMOTE branch is to push
<strong>NOTHING</strong> to it.  So consider the following command:</p>

<p><strong><code>git push origin :notifyme</code></strong></p>

<p>We&rsquo;re pushing to the origin named &lsquo;origin&rsquo;, but providing NO local branch name
and pushing that bit of nothing to the remote branch of &lsquo;notifyme&rsquo;. This
kills (deletes) the remote branch.</p>

<p>Finally, we push to our origin named &lsquo;origin&rsquo; again and push the contents of
the local branch &lsquo;garysawesomeenvironment&rsquo; to the remote branch of
&lsquo;garysawesomeenvironment&rsquo; which in turn CREATES that branch if it doesn&rsquo;t exist.
Whew.  Let&rsquo;s run another damn synchronization:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 production]# `r10k deploy environment -pv`
</span><span class='line'>[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
</span><span class='line'>&lt;more snippage&gt;
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment garysawesomeenvironment
</span><span class='line'>[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
</span><span class='line'>[R10K::Task::Module::Sync - INFO] Deploying notifyme into /etc/puppetlabs/puppet/environments/garysawesomeenvironment/modules
</span><span class='line'>&lt;more of that snipping shit&gt;
</span><span class='line'>R10K::Task::Deployment::PurgeEnvironments - INFO] Purging stale environments from /etc/puppetlabs/puppet/environments</span></code></pre></td></tr></table></div></figure>


<p>Cool, let&rsquo;s check out our <code>environments</code> folder on our VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 production]# ls -lah /etc/puppetlabs/puppet/environments/
</span><span class='line'>total 24K
</span><span class='line'>drwxr-xr-x 6 root root 4.0K Feb 19 13:34 .
</span><span class='line'>drwxr-xr-x 7 root root 4.0K Feb 19 12:09 ..
</span><span class='line'>drwxr-xr-x 4 root root 4.0K Feb 19 11:44 development
</span><span class='line'>drwxr-xr-x 5 root root 4.0K Feb 19 13:33 garysawesomeenvironment
</span><span class='line'>drwxr-xr-x 5 root root 4.0K Feb 19 11:43 master
</span><span class='line'>drwxr-xr-x 5 root root 4.0K Feb 19 11:42 production
</span><span class='line'>
</span><span class='line'>[root@master1 production]# cd /etc/puppetlabs/puppet/environments/garysawesomeenvironment/
</span><span class='line'>
</span><span class='line'>[root@master1 garysawesomeenvironment]# git branch
</span><span class='line'>* garysawesomeenvironment
</span><span class='line'>  master</span></code></pre></td></tr></table></div></figure>


<h3>Run Puppet to test the new environment</h3>

<p>Perfect!  Now classify your node to include the &lsquo;notifyme&rsquo; class, and let&rsquo;s run
Puppet to see what we get when we try to join the environment called
&lsquo;garysawesomeenvronment&rsquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# puppet agent -t --environment garysawesomeenvironment
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snipping facts loading for brevity&gt;
</span><span class='line'>Info: Caching catalog for master1
</span><span class='line'>Info: Applying configuration version '1392845863'
</span><span class='line'>Notice: This is the notifyme module and its master branch
</span><span class='line'>Notice: /Stage[main]/Notifyme/Notify[This is the notifyme module and its master branch]/message: defined 'message' as 'This is the notifyme module and its master branch'
</span><span class='line'>Notice: Finished catalog run in 11.10 seconds</span></code></pre></td></tr></table></div></figure>


<p>Cool!  Now let&rsquo;s try to run Puppet with another environment, say &lsquo;production&rsquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# puppet agent -t --environment production
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snipping facts loading for brevity&gt;
</span><span class='line'>Error: Could not retrieve catalog from remote server: Error 400 on SERVER: Could not find class notifyme for master1 on node master1
</span><span class='line'>Warning: Not using cache on failed catalog
</span><span class='line'>Error: Could not retrieve catalog; skipping run</span></code></pre></td></tr></table></div></figure>


<p>We get an error because that module hasn&rsquo;t been loaded by R10k for that
environment.</p>

<h3>Tie a module version to an environment</h3>

<p>Okay, so we added a module to a new environment, but what if we want to test
out a specific commit, branch, or tag of a module and test it in this new
environment? This is frequently what you&rsquo;ll be doing &ndash; making a change to
an existing module, pushing your change to a topic branch of that module&rsquo;s
repository, tying it to an environment (or creating a new environment by
branching the main Puppet repository), and then testing the change.</p>

<p>Let&rsquo;s go back to my &lsquo;notifyme&rsquo; module that I&rsquo;ve cloned to my laptop and push
a change to a BRANCH of that module&rsquo;s Github repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet-notifyme)▷ git branch
</span><span class='line'>* master
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git checkout -b change_the_message
</span><span class='line'>Switched to a new branch 'change_the_message'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ vim manifests/init.pp
</span><span class='line'>## Make changes to the notify message
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git add manifests/init.pp
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git commit
</span><span class='line'>[change_the_message bc3975b] Change the Message
</span><span class='line'> 1 file changed, 1 insertion(+), 1 deletion(-)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git push origin change_the_message:change_the_message
</span><span class='line'>Counting objects: 7, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (4/4), 448 bytes, done.
</span><span class='line'>Total 4 (delta 0), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet-notifyme.git
</span><span class='line'> * [new branch]      change_the_message -&gt; change_the_message
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git branch -a
</span><span class='line'>* change_the_message
</span><span class='line'>  master
</span><span class='line'>  remotes/origin/change_the_message
</span><span class='line'>  remotes/origin/master
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git log
</span><span class='line'>commit bc3975bb5c75ada86bfc2c45db628b5a156f85ce
</span><span class='line'>Author: Gary Larizza &lt;gary@puppetlabs.com&gt;
</span><span class='line'>Date:   Wed Feb 19 13:55:26 2014 -0800
</span><span class='line'>
</span><span class='line'>    Change the Message
</span><span class='line'>
</span><span class='line'>    This commit changes the message to test my workflow.</span></code></pre></td></tr></table></div></figure>


<p>What I&rsquo;m showing you is the workflow that creates a new local branch called
&lsquo;change_the_message&rsquo; to the notifyme module, changes the message in my notify
resource, commits the change, and pushes the changes to a remote branch ALSO
called &lsquo;change_the_message&rsquo;.</p>

<p>Because I created a topic branch, I can provide that branch name in the
<code>Puppetfile</code> located in the &lsquo;garysawesomeenvironment&rsquo; branch of the
<a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>. THAT is the piece that ties together the specific
version of the module with the Puppet environment we want on the Puppet master.
Here&rsquo;s that change:</p>

<figure class='code'><figcaption><span>Puppetfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="s2">&quot;notifyme&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;git://github.com/glarizza/puppet-notifyme.git&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;change_the_message&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, that change gets put into the &lsquo;garysawesomeenvironment&rsquo; branch of the
<a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a> and pushed up to the remote:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet_repository)▷ vim Puppetfile
</span><span class='line'>## Make changes
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git add Puppetfile
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git commit
</span><span class='line'>[garysawesomeenvironment 89b139c] Update garysawesomeenvironment
</span><span class='line'> 1 file changed, 2 insertions(+), 1 deletion(-)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git push origin garysawesomeenvironment:garysawesomeenvironment
</span><span class='line'>Counting objects: 5, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (3/3), 411 bytes, done.
</span><span class='line'>Total 3 (delta 1), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet_repository.git
</span><span class='line'>   5239538..89b139c  garysawesomeenvironment -&gt; garysawesomeenvironment
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git log -p
</span><span class='line'>commit 89b139c8c2faa888a402b98ea76e4ca138b3463d
</span><span class='line'>Author: Gary Larizza &lt;gary@puppetlabs.com&gt;
</span><span class='line'>Date:   Wed Feb 19 14:04:18 2014 -0800
</span><span class='line'>
</span><span class='line'>    Update garysawesomeenvironment
</span><span class='line'>
</span><span class='line'>    Tie this environment to the 'change_the_message' branch of my notifyme module.
</span><span class='line'>
</span><span class='line'>diff --git a/Puppetfile b/Puppetfile
</span><span class='line'>index 5e5d091..27fc06e 100644
</span><span class='line'>--- a/Puppetfile
</span><span class='line'>+++ b/Puppetfile
</span><span class='line'>@@ -31,4 +31,5 @@ mod 'redis',
</span><span class='line'>   :ref =&gt; 'feature/debian_support'
</span><span class='line'>
</span><span class='line'> mod "notifyme",
</span><span class='line'>-  :git =&gt; "git://github.com/glarizza/puppet-notifyme.git"
</span><span class='line'>+  :git =&gt; "git://github.com/glarizza/puppet-notifyme.git",
</span><span class='line'>+  :ref =&gt; 'change_the_message'</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s synchronize again!!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# `r10k deploy environment -pv`
</span><span class='line'>[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
</span><span class='line'>&lt;snip&gt;
</span><span class='line'>[R10K::Task::Environment::Deploy - NOTICE] Deploying environment garysawesomeenvironment
</span><span class='line'>[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
</span><span class='line'>&lt;snip&gt;</span></code></pre></td></tr></table></div></figure>


<p>Cool, let&rsquo;s check our work on the VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# pwd
</span><span class='line'>/etc/puppetlabs/puppet/environments/garysawesomeenvironment
</span><span class='line'>[root@master1 garysawesomeenvironment]# git branch
</span><span class='line'>* garysawesomeenvironment
</span><span class='line'>  master</span></code></pre></td></tr></table></div></figure>


<p>And finally, let&rsquo;s run Puppet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@master1 garysawesomeenvironment]# puppet agent -t --environment garysawesomeenvironment
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snip fact loading&gt;
</span><span class='line'>Info: Caching catalog for master1
</span><span class='line'>Info: Applying configuration version '1392847743'
</span><span class='line'>Notice: This is the changed message in the change_the_message branch
</span><span class='line'>Notice: /Stage[main]/Notifyme/Notify[This is the changed message in the change_the_message branch]/message: defined 'message' as 'This is the changed message in the change_the_message branch'
</span><span class='line'>Notice: Finished catalog run in 12.10 seconds</span></code></pre></td></tr></table></div></figure>


<p>TADA! We&rsquo;ve successfully tied a specific version of a module to a specific
dynamic environment, deployed it to a master, and tested it out! Smell that?
That&rsquo;s the smell of awesome. Or Jeff in the next cubicle eating a burrito.
Either way, I like it.</p>

<h3>Merge your changes with master/production</h3>

<p>It&rsquo;s green &ndash; fuck it; ship it! NOW you&rsquo;re speaking &lsquo;agile&rsquo;! Assuming everything
went according to plan, let&rsquo;s merge our changes in with the production
environment and synchronize.  This is up to your company&rsquo;s workflow docs
(whether you use pull requests, a merge master, or poke Patrick and tell
him to tell Andy to merge in your change). I&rsquo;m using git and Github, so
let&rsquo;s merge.</p>

<p>First, do the Module:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet-notifyme)▷ git checkout master
</span><span class='line'>Switched to branch 'master'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git merge change_the_message
</span><span class='line'>Updating d44a790..bc3975b
</span><span class='line'>Fast-forward
</span><span class='line'> manifests/init.pp | 2 +-
</span><span class='line'> 1 file changed, 1 insertion(+), 1 deletion(-)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git push origin master:master
</span><span class='line'>Total 0 (delta 0), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet-notifyme.git
</span><span class='line'>   d44a790..bc3975b  master -&gt; master
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ cat manifests/init.pp
</span><span class='line'>class notifyme {
</span><span class='line'>  notify { "This is the changed message in the change_the_message branch": }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>So now we have an issue, and that issue is that the production environment
has YET to have the &lsquo;notifyme&rsquo; module added to it.  If we merge the contents
of the &lsquo;garysawesomeenvironment&rsquo; branch with the &lsquo;production&rsquo; branch of the
<a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>, then we&rsquo;re going to be pointing at the
&lsquo;change_the_message&rsquo; branch of the &lsquo;notifyme&rsquo; module (because that was our last
commit).</p>

<p>Because of this, I can&rsquo;t do a straight merge, can I? For posterity&rsquo;s sake (in
the event that someone in the future wants to look for that branch on my Github
repo), I&rsquo;m going to keep that branch alive. In a production environment, I
most likely would NOT have additional branches open for all my component modules
as that would get pretty annoying/confusing. Understand that this is a one-off
case because I&rsquo;m doing a demo. BECAUSE of this, I&rsquo;m going to modify the
<code>Puppetfile</code> in the &lsquo;production&rsquo; branch of the <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet_repository)▷ git checkout production
</span><span class='line'>Switched to branch 'production'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ vim Puppetfile
</span><span class='line'>## Make changes here
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git add Puppetfile
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git commit
</span><span class='line'>[production a74f269] Add notifyme module to Production environment
</span><span class='line'> 1 file changed, 4 insertions(+)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git push origin production:production
</span><span class='line'>Counting objects: 5, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (3/3), 362 bytes, done.
</span><span class='line'>Total 3 (delta 1), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet_repository.git
</span><span class='line'>   5ecefc8..a74f269  production -&gt; production
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git log -p
</span><span class='line'>commit a74f26975102f3786eedddace89bda086162d801
</span><span class='line'>Author: Gary Larizza &lt;gary@puppetlabs.com&gt;
</span><span class='line'>Date:   Wed Feb 19 14:24:05 2014 -0800
</span><span class='line'>
</span><span class='line'>    Add notifyme module to Production environment
</span><span class='line'>
</span><span class='line'>diff --git a/Puppetfile b/Puppetfile
</span><span class='line'>index 0b1da68..9168a81 100644
</span><span class='line'>--- a/Puppetfile
</span><span class='line'>+++ b/Puppetfile
</span><span class='line'>@@ -29,3 +29,7 @@ mod "property_list_key",
</span><span class='line'> mod 'redis',
</span><span class='line'>   :git =&gt; 'git://github.com/glarizza/puppet-redis',
</span><span class='line'>   :ref =&gt; 'feature/debian_support'
</span><span class='line'>+
</span><span class='line'>+mod 'notifyme',
</span><span class='line'>+  :git =&gt; 'git://github.com/glarizza/puppet-notifyme'
</span><span class='line'>+</span></code></pre></td></tr></table></div></figure>


<p>Alright, we&rsquo;ve updated the production environment, now synchronize again
(I&rsquo;ll spare you and do it WITHOUT verbose mode):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# r10k deploy environment -p</span></code></pre></td></tr></table></div></figure>


<p>Okay, now run Puppet with the PRODUCTION environment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# puppet agent -t --environment production
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snipping fact loading&gt;
</span><span class='line'>Info: Caching catalog for master1
</span><span class='line'>Info: Applying configuration version '1392848588'
</span><span class='line'>Notice: This is the changed message in the change_the_message branch
</span><span class='line'>Notice: /Stage[main]/Notifyme/Notify[This is the changed message in the change_the_message branch]/message: defined 'message' as 'This is the changed message in the change_the_message branch'
</span><span class='line'>Notice: Finished catalog run in 12.66 seconds</span></code></pre></td></tr></table></div></figure>


<p>Beautiful, we&rsquo;re synchronized!!!</p>

<h3>Making a change to an EXISTING module in an environment</h3>

<p>Okay, so we saw previously how to add a NEW module to an environment, but what
if we already HAVE a module in an environment and we want to make an update/change
to it?  Well, it&rsquo;s largely the same process:</p>

<ul>
<li>Cut a branch to the module</li>
<li>Commit your code and push it up to the module&rsquo;s repo</li>
<li>Cut a branch to the <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a></li>
<li>Push that branch up to the <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a></li>
<li>Perform an R10k synchronization to sync the environments</li>
<li>Test your changes</li>
<li>Merge the changes with the master branch of the module</li>
<li>DONE!</li>
</ul>


<p>Let&rsquo;s go back and change that notify message again, shall we?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet-notifyme)▷ git checkout -b 'another_change'
</span><span class='line'>Switched to a new branch 'another_change'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ vim manifests/init.pp
</span><span class='line'>## Make changes to the message
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git add manifests/init.pp
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git commit
</span><span class='line'>[another_change 608166e] Change the message that already exists!
</span><span class='line'> 1 file changed, 1 insertion(+), 1 deletion(-)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git push origin another_change:another_change
</span><span class='line'>Counting objects: 7, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (4/4), 426 bytes, done.
</span><span class='line'>Total 4 (delta 0), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet-notifyme.git
</span><span class='line'> * [new branch]      another_change -&gt; another_change</span></code></pre></td></tr></table></div></figure>


<p>Okay, let&rsquo;s re-use &lsquo;garysawesomeenvironment&rsquo; because I like the name, but
tie it to the new &lsquo;another_change&rsquo; branch of the &lsquo;notifyme&rsquo; module:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet_repository)▷ git checkout garysawesomeenvironment
</span><span class='line'>Switched to branch 'garysawesomeenvironment'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ vim Puppetfile
</span><span class='line'>## Make change to Puppetfile to tie it to 'another_change' branch
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git add Puppetfile
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git commit
</span><span class='line'>[garysawesomeenvironment ce84a30] Tie garysawesomeenvironment to 'another_change'
</span><span class='line'> 1 file changed, 1 insertion(+), 1 deletion(-)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet_repository)▷ git push origin garysawesomeenvironment:garysawesomeenvironment
</span><span class='line'>Counting objects: 5, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (3/3), done.
</span><span class='line'>Writing objects: 100% (3/3), 386 bytes, done.
</span><span class='line'>Total 3 (delta 1), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet_repository.git
</span><span class='line'>   89b139c..ce84a30  garysawesomeenvironment -&gt; garysawesomeenvironment</span></code></pre></td></tr></table></div></figure>


<p>The <code>Puppetfile</code> for that branch now has an entry for the &lsquo;notifyme&rsquo; module
that looks like this:</p>

<figure class='code'><figcaption><span>Puppetfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="s2">&quot;notifyme&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;git://github.com/glarizza/puppet-notifyme.git&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;another_change&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, synchronize again!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# r10k deploy environment -p</span></code></pre></td></tr></table></div></figure>


<p>And now run Puppet in the &lsquo;garysawesomeenvironment&rsquo; environment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# puppet agent -t --environment garysawesomeenvironment
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snip fact loading&gt;
</span><span class='line'>Info: Caching catalog for master1
</span><span class='line'>Info: Applying configuration version '1392849521'
</span><span class='line'>Notice: This changes the message that already exists!!!!
</span><span class='line'>Notice: /Stage[main]/Notifyme/Notify[This changes the message that already exists!!!!]/message: defined 'message' as 'This changes the message that already exists!!!!'
</span><span class='line'>Notice: Finished catalog run in 12.54 seconds</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s the message that I changed in the &lsquo;another_change&rsquo; branch of my &lsquo;notifyme&rsquo;
module!  What&rsquo;s it look like if I run in the &lsquo;production&rsquo; environment, though?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>ot@master1 garysawesomeenvironment]# puppet agent -t --environment production
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snip fact loading&gt;
</span><span class='line'>Info: Caching catalog for master1
</span><span class='line'>Info: Applying configuration version '1392848588'
</span><span class='line'>Notice: This is the changed message in the change_the_message branch
</span><span class='line'>Notice: /Stage[main]/Notifyme/Notify[This is the changed message in the change_the_message branch]/message: defined 'message' as 'This is the changed message in the change_the_message branch'
</span><span class='line'>Notice: Finished catalog run in 14.11 seconds</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s the old message that&rsquo;s in the &lsquo;master&rsquo; branch of the &lsquo;notifyme&rsquo;
module (which is where the &lsquo;production&rsquo; branch <code>Puppetfile</code> is pointing).
To merge the changes into the production environment, we now only have to
do one thing: that&rsquo;s merge the changes in the &lsquo;another_change&rsquo; branch of
the &lsquo;notifyme&rsquo; module to the &lsquo;master&rsquo; branch &ndash; that&rsquo;s it!  Why? Because
the <code>Puppetfile</code> in the <code>production</code> branch of the <a href="https://github.com/glarizza/puppet_repository">main Puppet repo</a>
(and thus the production Puppet ENVIRONMENT) is already POINTING at the
master branch of the &lsquo;notifyme&rsquo; module.  Let&rsquo;s do the merge:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>└(~/src/puppet-notifyme)▷ git checkout master
</span><span class='line'>Switched to branch 'master'
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git merge another_change
</span><span class='line'>Updating bc3975b..608166e
</span><span class='line'>Fast-forward
</span><span class='line'> manifests/init.pp | 2 +-
</span><span class='line'> 1 file changed, 1 insertion(+), 1 deletion(-)
</span><span class='line'>
</span><span class='line'>└(~/src/puppet-notifyme)▷ git push origin master:master
</span><span class='line'>Total 0 (delta 0), reused 0 (delta 0)
</span><span class='line'>To https://github.com/glarizza/puppet-notifyme.git
</span><span class='line'>   bc3975b..608166e  master -&gt; master</span></code></pre></td></tr></table></div></figure>


<p>Another R10k synchronization is needed on the master:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# r10k deploy environment -p</span></code></pre></td></tr></table></div></figure>


<p>And now let&rsquo;s run Puppet in the production environment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master1 garysawesomeenvironment]# puppet agent -t --environment production
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>&lt;snip fact loading&gt;
</span><span class='line'>Info: Caching catalog for master1
</span><span class='line'>Info: Applying configuration version '1392850004'
</span><span class='line'>Notice: This changes the message that already exists!!!!
</span><span class='line'>Notice: /Stage[main]/Notifyme/Notify[This changes the message that already exists!!!!]/message: defined 'message' as 'This changes the message that already exists!!!!'
</span><span class='line'>Notice: Finished catalog run in 11.82 seconds</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s the message that was previously in the &lsquo;another_change&rsquo; branch that&rsquo;s
been merged to the &lsquo;master&rsquo; branch (and thus is entered into the production
Puppet environment).</p>

<h3>OR, use tags</h3>

<p>One more note &ndash; for production environments that want a BIT more stability
(rather than hoping that someone follows the policy of pushing commits to
a BRANCH of a module rather than pushing directly to master &ndash; by accident or
otherwise &ndash; and allowing that commit to make DIRECTLY it into production), the
better way is to tie all modules to some sort of release version. For modules
released to the Puppet Forge, that&rsquo;s a version, for modules stored in git
repositories, that would be a tag. Tying all modules in your production
environment (and thus production <code>Puppetfile</code>) to specific tags in git
repositories IS a &ldquo;best practice&rdquo; to ensure that the code that&rsquo;s executed in
production has some sort of &lsquo;safe guard&rsquo;.</p>

<p>TL;DR: Example tied to &lsquo;master&rsquo; branch above was demo, and not necessarily
recommended for your production needs.</p>

<h2>Holy crap, that&rsquo;s a lot to take in&hellip;</h2>

<p>Yeah, tell me about it. And, believe it or not, I&rsquo;m STILL not done with
everything that I want to talk about regarding R10k &ndash; there&rsquo;s still more
info on:</p>

<ul>
<li>Using R10k with a monolithic modules repo</li>
<li>Incorporating Hiera data</li>
<li>Triggering R10k with MCollective</li>
<li>Tying R10k to CI workflow</li>
</ul>


<p>Those will come in a later post once I have time to decide how to tackle them.
Until then, this should give you more than enough information to get started
with R10k in your own environment.</p>

<p>If you have any questions/comments/corrections, PLEASE enter them in the
comments below and I&rsquo;ll be happy to respond when I&rsquo;m not flying from gig to
gig! :)  Cheers!</p>

<p><strong>EDIT</strong>: 2/19/2014 &ndash; correct librarian-puppet assumption thanks to Reid Vandewiele</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Gary larizza</span></span>

      








  


<time datetime="2014-02-18T09:48:18-08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/environments/'>environments</a>, <a class='category' href='/blog/categories/puppet/'>puppet</a>, <a class='category' href='/blog/categories/r10k/'>r10k</a>, <a class='category' href='/blog/categories/workflow/'>workflow</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://garylarizza.com/blog/2014/02/18/puppet-workflow-part-3/" data-via="glarizza" data-counturl="http://garylarizza.com/blog/2014/02/18/puppet-workflow-part-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/17/puppet-workflow-part-2/" title="Previous Post: Building a Functional Puppet Workflow Part 2: Roles and Profiles">&laquo; Building a Functional Puppet Workflow Part 2: Roles and Profiles</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/03/07/puppet-workflow-part-3b/" title="Next Post: Building a Functional Puppet Workflow Part 3b: More R10k Madness">Building a Functional Puppet Workflow Part 3b: More R10k Madness &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/02/07/data-escalation-path/">Data Escalation Path: Does It Go in the Profile or Hiera?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/17/roles-and-profiles-in-a-control-repo/">Roles and Profiles in a Control Repo?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/16/workflows-evolved-even-besterer-practices/">Workflows Evolved: Even Besterer Practices</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/puppet-workflows-4-using-hiera-in-anger/">Puppet Workflows 4: Using Hiera in Anger</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/23/puppetconf-2014-talk/">Puppetconf 2014 Talk - the Refactor Dance</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/glarizza">@glarizza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'glarizza',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Twitter</h1>
  <a class="twitter-timeline" href="https://twitter.com/glarizza" data-widget-id="406925439601348608">Tweets by @glarizza</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>





<section>
  <h1>Coderwall Badges</h1>
  <ul id="cw_badges">
    <li class="loading">Status updating...</li>
  </ul>
  <p id="badges"></p>
  <script type="text/javascript">
    function show_achievements(args) {
      var badges = args["data"]["badges"];
      var achievements = "";
      for (var i = 0; i < badges.length; i++) {
        var alt_text = badges[i]["name"];
        var title_text = badges[i]["name"] + ' - ' + badges[i]["description"];
        achievements += '<a href="http://coderwall.com/glarizza/"><img src="'
          + badges[i]["badge"]
          + '" width="48" height="48" alt="' + alt_text
          + '" title="' + title_text
          + '" style="margin-top: 7px;margin-right: 4px;"'
          + '"/></a>';
      };
      document.getElementById("cw_badges").style.display = "none";
      document.getElementById("badges").innerHTML = achievements;
    }
  </script>
  <script src="http://coderwall.com/glarizza.json?callback=show_achievements"></script>
  
</section>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- shit gary says ad -->
<ins class="adsbygoogle"
     style="display:inline-block;width:336px;height:280px"
     data-ad-client="ca-pub-7679900559570586"
     data-ad-slot="2428332156"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Gary larizza -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'shitgarysays';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://garylarizza.com/blog/2014/02/18/puppet-workflow-part-3/';
        var disqus_url = 'http://garylarizza.com/blog/2014/02/18/puppet-workflow-part-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
